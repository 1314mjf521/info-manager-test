<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠŸèƒ½å®Œæ•´è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #66b1ff;
        }
        button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }
        button.success {
            background: #67c23a;
        }
        button.warning {
            background: #e6a23c;
        }
        button.danger {
            background: #f56c6c;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            color: #0066cc;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffb3b3;
            color: #cc0000;
        }
        .info {
            background: #f9f9f9;
            border: 1px solid #d9d9d9;
            color: #666;
        }
        .warning {
            background: #fffbf0;
            border: 1px solid #f0d000;
            color: #b8860b;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #67c23a; }
        .status-error { background: #f56c6c; }
        .status-warning { background: #e6a23c; }
        .status-info { background: #409eff; }
        
        .step-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #409eff, #67c23a);
            transition: width 0.3s ease;
        }
        
        #loginSection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        #loginSection label {
            color: white;
        }
        
        #loginSection input, #loginSection textarea {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #loginSection .result {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        #loginSection .result.success {
            background: rgba(103, 194, 58, 0.2);
            border-color: rgba(103, 194, 58, 0.5);
        }
        
        #loginSection .result.error {
            background: rgba(245, 108, 108, 0.2);
            border-color: rgba(245, 108, 108, 0.5);
        }
        
        .login-tips {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ AIåŠŸèƒ½å®Œæ•´è¯Šæ–­å·¥å…·</h1>
        <p>å…¨é¢è¯Šæ–­AIé…ç½®ä¿å­˜ã€è·å–å’ŒèŠå¤©åŠŸèƒ½çš„é—®é¢˜ã€‚</p>
        
        <!-- ç™»å½•çŠ¶æ€å’Œæ§åˆ¶ -->
        <div class="test-section" id="loginSection">
            <h3><span class="status-indicator status-warning" id="loginStatus"></span>ç”¨æˆ·ç™»å½•çŠ¶æ€</h3>
            <div id="loginInfo" class="result info">æ£€æŸ¥ç™»å½•çŠ¶æ€...</div>
            
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" style="display: none;">
                <div class="form-row">
                    <div>
                        <label>ç”¨æˆ·å:</label>
                        <input type="text" id="username" value="admin" placeholder="è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div>
                        <label>å¯†ç :</label>
                        <input type="password" id="password" value="admin123" placeholder="è¾“å…¥å¯†ç ">
                    </div>
                </div>
                <button onclick="performLogin()" id="loginBtn">ç™»å½•</button>
                <button onclick="showTokenInput()" id="tokenBtn">ä½¿ç”¨Token</button>
            </div>
            
            <!-- Tokenè¾“å…¥ -->
            <div id="tokenForm" style="display: none;">
                <label>ç›´æ¥è¾“å…¥Token:</label>
                <textarea id="tokenInput" rows="3" placeholder="ç²˜è´´æ‚¨çš„JWT Token"></textarea>
                <button onclick="setToken()" id="setTokenBtn">è®¾ç½®Token</button>
            </div>
            
            <button onclick="logout()" id="logoutBtn" style="display: none;" class="danger">é€€å‡ºç™»å½•</button>
            
            <div class="login-tips">
                ğŸ’¡ <strong>ä½¿ç”¨æç¤º:</strong><br>
                â€¢ é»˜è®¤ç®¡ç†å‘˜è´¦å·: admin / admin123<br>
                â€¢ å¦‚æœæ‚¨å·²åœ¨ç³»ç»Ÿä¸­ç™»å½•ï¼Œå¯ä»¥ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„localStorageä¸­å¤åˆ¶token<br>
                â€¢ Tokenæ ¼å¼é€šå¸¸ä»¥ "eyJ" å¼€å¤´çš„é•¿å­—ç¬¦ä¸²
            </div>
        </div>
        
        <!-- è¯Šæ–­è¿›åº¦ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>
        <div id="progressText">è¯·å…ˆç™»å½•ç³»ç»Ÿ...</div>
    </div>

    <div class="step-container">
        <!-- å·¦ä¾§ï¼šç³»ç»Ÿæ£€æŸ¥ -->
        <div class="container">
            <h2>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
            
            <!-- 1. è¿æ¥æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status1"></span>1. åç«¯è¿æ¥æµ‹è¯•</h3>
                <button onclick="testConnection()" id="btn1">æµ‹è¯•è¿æ¥</button>
                <div id="result1" class="result info">ç­‰å¾…æµ‹è¯•...</div>
            </div>

            <!-- 2. è®¤è¯æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status2"></span>2. ç”¨æˆ·è®¤è¯æµ‹è¯•</h3>
                <button onclick="testAuth()" id="btn2">æµ‹è¯•è®¤è¯</button>
                <div id="result2" class="result info">ç­‰å¾…æµ‹è¯•...</div>
            </div>

            <!-- 3. æƒé™æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status3"></span>3. AIæƒé™æµ‹è¯•</h3>
                <button onclick="testPermissions()" id="btn3">æµ‹è¯•æƒé™</button>
                <div id="result3" class="result info">ç­‰å¾…æµ‹è¯•...</div>
            </div>

            <!-- 4. æ•°æ®åº“çŠ¶æ€ -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status4"></span>4. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥</h3>
                <button onclick="checkDatabase()" id="btn4">æ£€æŸ¥æ•°æ®åº“</button>
                <div id="result4" class="result info">ç­‰å¾…æ£€æŸ¥...</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šåŠŸèƒ½æµ‹è¯• -->
        <div class="container">
            <h2>âš™ï¸ åŠŸèƒ½æµ‹è¯•</h2>
            
            <!-- 5. é…ç½®ä¿å­˜æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status5"></span>5. é…ç½®ä¿å­˜æµ‹è¯•</h3>
                <div class="form-row">
                    <div>
                        <label>é…ç½®åç§°:</label>
                        <input type="text" id="testConfigName" value="è¯Šæ–­æµ‹è¯•é…ç½®" placeholder="è¾“å…¥é…ç½®åç§°">
                    </div>
                    <div>
                        <label>æœåŠ¡æä¾›å•†:</label>
                        <select id="testProvider" onchange="handleProviderChange()">
                            <option value="openai">OpenAI</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="custom">è‡ªå®šä¹‰/æœ¬åœ°æ¨¡å‹</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>æ¨¡å‹:</label>
                        <input type="text" id="testModel" value="gpt-3.5-turbo" placeholder="è¾“å…¥æ¨¡å‹åç§°">
                    </div>
                    <div>
                        <label>APIå¯†é’¥:</label>
                        <input type="password" id="testApiKey" placeholder="è¾“å…¥æµ‹è¯•APIå¯†é’¥">
                    </div>
                </div>
                
                <label>APIç«¯ç‚¹ (æœ¬åœ°/è‡ªå®šä¹‰æ¨¡å‹å¿…å¡«):</label>
                <input type="text" id="testApiEndpoint" placeholder="å¦‚: http://localhost:8000/v1 æˆ– https://your-api.com/v1">
                
                <div class="form-row">
                    <div>
                        <label>æœ€å¤§Tokenæ•°:</label>
                        <input type="number" id="testMaxTokens" value="4096" min="1" max="32000">
                    </div>
                    <div>
                        <label>æ¸©åº¦å‚æ•°:</label>
                        <input type="number" id="testTemperature" value="0.7" min="0" max="2" step="0.1">
                    </div>
                </div>
                <button onclick="testConfigSave()" id="btn5">æµ‹è¯•ä¿å­˜é…ç½®</button>
                <div id="result5" class="result info">å¡«å†™ä¿¡æ¯åç‚¹å‡»æµ‹è¯•...</div>
            </div>

            <!-- 6. é…ç½®è·å–æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status6"></span>6. é…ç½®è·å–æµ‹è¯•</h3>
                <button onclick="testConfigFetch()" id="btn6">è·å–é…ç½®åˆ—è¡¨</button>
                <button onclick="testConfigFetchWithParams()" id="btn6b">å¸¦å‚æ•°è·å–</button>
                <div id="result6" class="result info">ç­‰å¾…æµ‹è¯•...</div>
            </div>

            <!-- 7. èŠå¤©åŠŸèƒ½æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status7"></span>7. èŠå¤©åŠŸèƒ½æµ‹è¯•</h3>
                <input type="text" id="testMessage" value="ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">
                <button onclick="testChat()" id="btn7">æµ‹è¯•èŠå¤©</button>
                <div id="result7" class="result info">éœ€è¦å…ˆæœ‰å¯ç”¨é…ç½®...</div>
            </div>

            <!-- 8. å®Œæ•´æµç¨‹æµ‹è¯• -->
            <div class="test-section">
                <h3><span class="status-indicator status-info" id="status8"></span>8. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
                <button onclick="runCompleteTest()" id="btn8" class="success">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button onclick="runAutoFix()" id="btn8b" class="warning">è‡ªåŠ¨ä¿®å¤</button>
                <div id="result8" class="result info">ç‚¹å‡»è¿è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <!-- ä¿®å¤å»ºè®® -->
    <div class="container">
        <h2>ğŸ› ï¸ ä¿®å¤å»ºè®®</h2>
        <div id="fixSuggestions" class="result info">
            è¿è¡Œè¯Šæ–­åå°†æ˜¾ç¤ºå…·ä½“çš„ä¿®å¤å»ºè®®...
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:8080/api/v1';
        let testResults = {};
        let currentStep = 0;
        let totalSteps = 8;
        
        // è·å–è®¤è¯token
        function getAuthToken() {
            // ä¼˜å…ˆä»è¯Šæ–­å·¥å…·çš„å­˜å‚¨è·å–
            let token = localStorage.getItem('diagnosis-token');
            if (token) {
                return token;
            }
            
            // å°è¯•ä»åº”ç”¨çš„å­˜å‚¨è·å–
            const authData = localStorage.getItem('auth-store');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    return parsed.token;
                } catch (e) {
                    console.log('æ— æ³•è§£æè®¤è¯æ•°æ®');
                }
            }
            return null;
        }

        // è®¾ç½®è®¤è¯token
        function setAuthToken(token) {
            localStorage.setItem('diagnosis-token', token);
            updateLoginStatus();
        }

        // æ¸…é™¤è®¤è¯token
        function clearAuthToken() {
            localStorage.removeItem('diagnosis-token');
            updateLoginStatus();
        }

        // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
        function updateLoginStatus() {
            const token = getAuthToken();
            const loginInfo = document.getElementById('loginInfo');
            const loginForm = document.getElementById('loginForm');
            const tokenForm = document.getElementById('tokenForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginStatus = document.getElementById('loginStatus');
            const progressText = document.getElementById('progressText');

            if (token) {
                loginStatus.className = 'status-indicator status-success';
                loginInfo.textContent = `âœ… å·²ç™»å½•\nToken: ${token.substring(0, 30)}...\nçŠ¶æ€: å¯ä»¥å¼€å§‹è¯Šæ–­`;
                loginInfo.className = 'result success';
                loginForm.style.display = 'none';
                tokenForm.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                progressText.textContent = 'å·²ç™»å½•ï¼Œå¯ä»¥å¼€å§‹è¯Šæ–­...';
            } else {
                loginStatus.className = 'status-indicator status-warning';
                loginInfo.textContent = 'âš ï¸ æœªç™»å½•\nè¯·å…ˆç™»å½•ç³»ç»Ÿæˆ–è¾“å…¥æœ‰æ•ˆçš„Token';
                loginInfo.className = 'result warning';
                loginForm.style.display = 'block';
                tokenForm.style.display = 'none';
                logoutBtn.style.display = 'none';
                progressText.textContent = 'è¯·å…ˆç™»å½•ç³»ç»Ÿ...';
            }
        }

        // æ‰§è¡Œç™»å½•
        async function performLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginInfo = document.getElementById('loginInfo');

            if (!username || !password) {
                loginInfo.textContent = 'âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                loginInfo.className = 'result error';
                return;
            }

            loginBtn.disabled = true;
            loginInfo.textContent = 'æ­£åœ¨ç™»å½•...';
            loginInfo.className = 'result info';

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (response.ok && data.data && data.data.token) {
                    setAuthToken(data.data.token);
                    loginInfo.textContent = `âœ… ç™»å½•æˆåŠŸï¼\nç”¨æˆ·: ${data.data.user?.username || username}\nTokenå·²ä¿å­˜`;
                    loginInfo.className = 'result success';
                } else {
                    loginInfo.textContent = `âŒ ç™»å½•å¤±è´¥\né”™è¯¯: ${data.error || data.message || 'æœªçŸ¥é”™è¯¯'}`;
                    loginInfo.className = 'result error';
                }
            } catch (error) {
                loginInfo.textContent = `âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`;
                loginInfo.className = 'result error';
            } finally {
                loginBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºTokenè¾“å…¥
        function showTokenInput() {
            const loginForm = document.getElementById('loginForm');
            const tokenForm = document.getElementById('tokenForm');
            
            loginForm.style.display = 'none';
            tokenForm.style.display = 'block';
        }

        // è®¾ç½®Token
        function setToken() {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim();
            const loginInfo = document.getElementById('loginInfo');

            if (!token) {
                loginInfo.textContent = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„Token';
                loginInfo.className = 'result error';
                return;
            }

            setAuthToken(token);
            loginInfo.textContent = `âœ… Tokenå·²è®¾ç½®\n${token.substring(0, 50)}...`;
            loginInfo.className = 'result success';
            tokenInput.value = '';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            clearAuthToken();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('tokenInput').value = '';
            
            // é‡ç½®æ‰€æœ‰æµ‹è¯•çŠ¶æ€
            currentStep = 0;
            testResults = {};
            document.getElementById('progressBar').style.width = '0%';
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€æŒ‡ç¤ºå™¨
            for (let i = 1; i <= 8; i++) {
                updateStatus(i, 'info');
                const resultDiv = document.getElementById(`result${i}`);
                if (resultDiv) {
                    resultDiv.textContent = 'ç­‰å¾…æµ‹è¯•...';
                    resultDiv.className = 'result info';
                }
            }
        }

        // é€šç”¨è¯·æ±‚å‡½æ•°
        async function makeRequest(url, options = {}) {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }

            const response = await fetch(url, {
                ...options,
                headers
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                const text = await response.text();
                data = { error: 'Invalid JSON response', rawResponse: text };
            }
            
            return { response, data };
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        function checkLoginRequired() {
            const token = getAuthToken();
            if (!token) {
                alert('è¯·å…ˆç™»å½•ç³»ç»Ÿï¼');
                return false;
            }
            return true;
        }

        // å¤„ç†æä¾›å•†å˜åŒ–
        function handleProviderChange() {
            const provider = document.getElementById('testProvider').value;
            const modelInput = document.getElementById('testModel');
            const endpointInput = document.getElementById('testApiEndpoint');
            const apiKeyInput = document.getElementById('testApiKey');

            // æ ¹æ®æä¾›å•†è®¾ç½®é»˜è®¤å€¼
            switch (provider) {
                case 'openai':
                    modelInput.value = 'gpt-3.5-turbo';
                    endpointInput.value = '';
                    endpointInput.placeholder = 'ä½¿ç”¨é»˜è®¤OpenAIç«¯ç‚¹';
                    apiKeyInput.placeholder = 'è¾“å…¥OpenAI APIå¯†é’¥ (sk-...)';
                    break;
                case 'azure':
                    modelInput.value = 'gpt-35-turbo';
                    endpointInput.value = '';
                    endpointInput.placeholder = 'https://your-resource.openai.azure.com';
                    apiKeyInput.placeholder = 'è¾“å…¥Azure OpenAI APIå¯†é’¥';
                    break;
                case 'anthropic':
                    modelInput.value = 'claude-3-sonnet-20240229';
                    endpointInput.value = '';
                    endpointInput.placeholder = 'ä½¿ç”¨é»˜è®¤Anthropicç«¯ç‚¹';
                    apiKeyInput.placeholder = 'è¾“å…¥Anthropic APIå¯†é’¥';
                    break;
                case 'custom':
                    modelInput.value = 'llama-2-7b-chat';
                    endpointInput.value = 'http://localhost:8000/v1';
                    endpointInput.placeholder = 'http://localhost:8000/v1 æˆ– https://your-api.com/v1';
                    apiKeyInput.placeholder = 'è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹APIå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰';
                    break;
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(stepId, status) {
            const indicator = document.getElementById(`status${stepId}`);
            indicator.className = `status-indicator status-${status}`;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            currentStep++;
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `è¯Šæ–­è¿›åº¦: ${currentStep}/${totalSteps} (${Math.round(progress)}%)`;
        }

        // 1. æµ‹è¯•è¿æ¥
        async function testConnection() {
            const resultDiv = document.getElementById('result1');
            const btn = document.getElementById('btn1');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...';
            resultDiv.className = 'result info';

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/system/health`);
                
                if (response.ok) {
                    testResults.connection = true;
                    updateStatus(1, 'success');
                    resultDiv.textContent = `âœ… åç«¯è¿æ¥æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nå“åº”æ—¶é—´: ${Date.now() - performance.now()}ms\næœåŠ¡å™¨ä¿¡æ¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    testResults.connection = false;
                    updateStatus(1, 'error');
                    resultDiv.textContent = `âŒ åç«¯è¿æ¥å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.connection = false;
                updateStatus(1, 'error');
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 2. æµ‹è¯•è®¤è¯
        async function testAuth() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result2');
            const btn = document.getElementById('btn2');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·è®¤è¯...';
            resultDiv.className = 'result info';

            const token = getAuthToken();
            if (!token) {
                testResults.auth = false;
                updateStatus(2, 'error');
                resultDiv.textContent = 'âŒ æœªæ‰¾åˆ°è®¤è¯Token\nè¯·å…ˆç™»å½•ç³»ç»Ÿ';
                resultDiv.className = 'result error';
                btn.disabled = false;
                updateProgress();
                return;
            }

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/users/profile`);
                
                if (response.ok) {
                    testResults.auth = true;
                    testResults.user = data.data;
                    updateStatus(2, 'success');
                    resultDiv.textContent = `âœ… ç”¨æˆ·è®¤è¯æˆåŠŸï¼\nToken: ${token.substring(0, 20)}...\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(data.data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    testResults.auth = false;
                    updateStatus(2, 'error');
                    resultDiv.textContent = `âŒ è®¤è¯å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.auth = false;
                updateStatus(2, 'error');
                resultDiv.textContent = `âŒ è®¤è¯æµ‹è¯•é”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 3. æµ‹è¯•æƒé™
        async function testPermissions() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result3');
            const btn = document.getElementById('btn3');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•AIç›¸å…³æƒé™...';
            resultDiv.className = 'result info';

            try {
                // æµ‹è¯•AIé…ç½®æƒé™
                const { response: configResponse, data: configData } = await makeRequest(`${API_BASE_URL}/ai/config`);
                
                if (configResponse.ok) {
                    testResults.permissions = true;
                    updateStatus(3, 'success');
                    resultDiv.textContent = `âœ… AIæƒé™éªŒè¯æˆåŠŸï¼\nå¯ä»¥è®¿é—®AIé…ç½®æ¥å£\næƒé™çŠ¶æ€: æ­£å¸¸`;
                    resultDiv.className = 'result success';
                } else if (configResponse.status === 403) {
                    testResults.permissions = false;
                    updateStatus(3, 'error');
                    resultDiv.textContent = `âŒ AIæƒé™ä¸è¶³\nçŠ¶æ€ç : 403\néœ€è¦AIç›¸å…³æƒé™æ‰èƒ½ä½¿ç”¨åŠŸèƒ½`;
                    resultDiv.className = 'result error';
                } else {
                    testResults.permissions = 'unknown';
                    updateStatus(3, 'warning');
                    resultDiv.textContent = `âš ï¸ æƒé™çŠ¶æ€æœªçŸ¥\nçŠ¶æ€ç : ${configResponse.status}\nå“åº”: ${JSON.stringify(configData, null, 2)}`;
                    resultDiv.className = 'result warning';
                }
            } catch (error) {
                testResults.permissions = false;
                updateStatus(3, 'error');
                resultDiv.textContent = `âŒ æƒé™æµ‹è¯•é”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 4. æ£€æŸ¥æ•°æ®åº“
        async function checkDatabase() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result4');
            const btn = document.getElementById('btn4');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...';
            resultDiv.className = 'result info';

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/ai/config?page=1&page_size=100`);
                
                if (response.ok) {
                    let configs = [];
                    if (data.data && data.data.configs) {
                        configs = data.data.configs;
                    } else if (data.data && Array.isArray(data.data)) {
                        configs = data.data;
                    }

                    testResults.database = {
                        accessible: true,
                        configCount: configs.length,
                        configs: configs
                    };

                    if (configs.length > 0) {
                        updateStatus(4, 'success');
                        resultDiv.textContent = `âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸ï¼\næ‰¾åˆ° ${configs.length} ä¸ªAIé…ç½®\n\né…ç½®åˆ—è¡¨:\n${configs.map(config => 
                            `- ID: ${config.id}, åç§°: ${config.name}, æä¾›å•†: ${config.provider}, çŠ¶æ€: ${config.status}`
                        ).join('\n')}`;
                        resultDiv.className = 'result success';
                    } else {
                        updateStatus(4, 'warning');
                        resultDiv.textContent = `âš ï¸ æ•°æ®åº“å¯è®¿é—®ä½†æ— é…ç½®æ•°æ®\né…ç½®æ•°é‡: 0\nè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆAIåŠŸèƒ½æ— æ³•ä½¿ç”¨`;
                        resultDiv.className = 'result warning';
                    }
                } else {
                    testResults.database = { accessible: false, error: data };
                    updateStatus(4, 'error');
                    resultDiv.textContent = `âŒ æ•°æ®åº“è®¿é—®å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.database = { accessible: false, error: error.message };
                updateStatus(4, 'error');
                resultDiv.textContent = `âŒ æ•°æ®åº“æ£€æŸ¥é”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 5. æµ‹è¯•é…ç½®ä¿å­˜
        async function testConfigSave() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result5');
            const btn = document.getElementById('btn5');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•é…ç½®ä¿å­˜...';
            resultDiv.className = 'result info';

            const configData = {
                name: document.getElementById('testConfigName').value,
                provider: document.getElementById('testProvider').value,
                model: document.getElementById('testModel').value,
                api_key: document.getElementById('testApiKey').value || 'sk-test-key-for-diagnosis-only',
                api_endpoint: document.getElementById('testApiEndpoint').value || '',
                config: '',
                categories: ['chat'],
                tags: ['test', 'diagnosis'],
                description: 'è¯Šæ–­å·¥å…·åˆ›å»ºçš„æµ‹è¯•é…ç½®',
                priority: 5,
                is_active: true,
                is_default: false,
                max_tokens: parseInt(document.getElementById('testMaxTokens').value) || 4096,
                temperature: parseFloat(document.getElementById('testTemperature').value) || 0.7,
                daily_limit: 0,
                monthly_limit: 0,
                cost_per_token: 0
            };

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/ai/config`, {
                    method: 'POST',
                    body: JSON.stringify(configData)
                });
                
                if (response.ok) {
                    testResults.configSave = { success: true, configId: data.data?.id };
                    updateStatus(5, 'success');
                    resultDiv.textContent = `âœ… é…ç½®ä¿å­˜æˆåŠŸï¼\né…ç½®ID: ${data.data?.id}\né…ç½®åç§°: ${configData.name}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    testResults.configSave = { success: false, error: data };
                    updateStatus(5, 'error');
                    resultDiv.textContent = `âŒ é…ç½®ä¿å­˜å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯è¯¦æƒ…: ${JSON.stringify(data, null, 2)}\n\nå‘é€çš„æ•°æ®:\n${JSON.stringify(configData, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.configSave = { success: false, error: error.message };
                updateStatus(5, 'error');
                resultDiv.textContent = `âŒ é…ç½®ä¿å­˜ç½‘ç»œé”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 6. æµ‹è¯•é…ç½®è·å–
        async function testConfigFetch() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result6');
            const btn = document.getElementById('btn6');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•é…ç½®è·å–...';
            resultDiv.className = 'result info';

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/ai/config`);
                
                if (response.ok) {
                    let configs = [];
                    if (data.data && data.data.configs) {
                        configs = data.data.configs;
                    } else if (data.data && Array.isArray(data.data)) {
                        configs = data.data;
                    }

                    testResults.configFetch = { success: true, count: configs.length, configs: configs };
                    
                    if (configs.length > 0) {
                        updateStatus(6, 'success');
                        resultDiv.textContent = `âœ… é…ç½®è·å–æˆåŠŸï¼\næ‰¾åˆ° ${configs.length} ä¸ªé…ç½®\n\né…ç½®è¯¦æƒ…:\n${configs.map(config => 
                            `ID: ${config.id} | åç§°: ${config.name} | æä¾›å•†: ${config.provider} | æ¨¡å‹: ${config.model} | çŠ¶æ€: ${config.status}`
                        ).join('\n')}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;
                        resultDiv.className = 'result success';
                    } else {
                        updateStatus(6, 'warning');
                        resultDiv.textContent = `âš ï¸ é…ç½®è·å–æˆåŠŸä½†æ— æ•°æ®\né…ç½®æ•°é‡: 0\nå“åº”æ ¼å¼: ${JSON.stringify(data, null, 2)}`;
                        resultDiv.className = 'result warning';
                    }
                } else {
                    testResults.configFetch = { success: false, error: data };
                    updateStatus(6, 'error');
                    resultDiv.textContent = `âŒ é…ç½®è·å–å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.configFetch = { success: false, error: error.message };
                updateStatus(6, 'error');
                resultDiv.textContent = `âŒ é…ç½®è·å–ç½‘ç»œé”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 6b. å¸¦å‚æ•°è·å–é…ç½®
        async function testConfigFetchWithParams() {
            const resultDiv = document.getElementById('result6');
            
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å¸¦å‚æ•°çš„é…ç½®è·å–...';
            resultDiv.className = 'result info';

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/ai/config?page=1&page_size=50&provider=openai`);
                
                resultDiv.textContent += `\n\nå¸¦å‚æ•°è·å–ç»“æœ:\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.textContent += `\n\nå¸¦å‚æ•°è·å–é”™è¯¯: ${error.message}`;
            }
        }

        // 7. æµ‹è¯•èŠå¤©åŠŸèƒ½
        async function testChat() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result7');
            const btn = document.getElementById('btn7');
            
            btn.disabled = true;
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•èŠå¤©åŠŸèƒ½...';
            resultDiv.className = 'result info';

            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨é…ç½®
            if (!testResults.configFetch || !testResults.configFetch.success || testResults.configFetch.count === 0) {
                updateStatus(7, 'warning');
                resultDiv.textContent = 'âš ï¸ æ— æ³•æµ‹è¯•èŠå¤©åŠŸèƒ½\nåŸå› : æ²¡æœ‰å¯ç”¨çš„AIé…ç½®\nè¯·å…ˆæˆåŠŸä¿å­˜è‡³å°‘ä¸€ä¸ªé…ç½®';
                resultDiv.className = 'result warning';
                btn.disabled = false;
                updateProgress();
                return;
            }

            const configId = testResults.configFetch.configs[0].id;
            const message = document.getElementById('testMessage').value;

            try {
                const { response, data } = await makeRequest(`${API_BASE_URL}/ai/chat`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        config_id: configId,
                        session_id: null
                    })
                });
                
                if (response.ok) {
                    testResults.chat = { success: true, response: data };
                    updateStatus(7, 'success');
                    resultDiv.textContent = `âœ… èŠå¤©åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼\nä½¿ç”¨é…ç½®ID: ${configId}\næµ‹è¯•æ¶ˆæ¯: ${message}\n\nå“åº”: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    testResults.chat = { success: false, error: data };
                    updateStatus(7, 'error');
                    resultDiv.textContent = `âŒ èŠå¤©åŠŸèƒ½æµ‹è¯•å¤±è´¥\nçŠ¶æ€ç : ${response.status}\né”™è¯¯: ${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                testResults.chat = { success: false, error: error.message };
                updateStatus(7, 'error');
                resultDiv.textContent = `âŒ èŠå¤©åŠŸèƒ½ç½‘ç»œé”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
                updateProgress();
            }
        }

        // 8. è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runCompleteTest() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result8');
            const btn = document.getElementById('btn8');
            
            btn.disabled = true;
            currentStep = 0;
            testResults = {};
            
            resultDiv.textContent = 'å¼€å§‹è¿è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•...\n';
            resultDiv.className = 'result info';

            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            for (let i = 1; i <= 8; i++) {
                updateStatus(i, 'info');
            }

            try {
                await testConnection();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testAuth();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testPermissions();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await checkDatabase();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testConfigSave();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testConfigFetch();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testChat();
                
                // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
                generateDiagnosisReport();
                
                updateStatus(8, 'success');
                resultDiv.textContent = 'âœ… å®Œæ•´æµ‹è¯•å®Œæˆï¼\nè¯·æŸ¥çœ‹ä¸‹æ–¹çš„è¯Šæ–­æŠ¥å‘Šå’Œä¿®å¤å»ºè®®ã€‚';
                resultDiv.className = 'result success';
                
            } catch (error) {
                updateStatus(8, 'error');
                resultDiv.textContent = `âŒ å®Œæ•´æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
            }
        }

        // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        function generateDiagnosisReport() {
            const fixDiv = document.getElementById('fixSuggestions');
            let report = 'ğŸ“Š è¯Šæ–­æŠ¥å‘Š\n\n';
            let suggestions = [];

            // åˆ†ææµ‹è¯•ç»“æœ
            if (!testResults.connection) {
                suggestions.push('ğŸ”´ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ - è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œç«¯å£æ˜¯å¦æ­£ç¡®');
            }

            if (!testResults.auth) {
                suggestions.push('ğŸ”´ ç”¨æˆ·è®¤è¯å¤±è´¥ - è¯·é‡æ–°ç™»å½•ç³»ç»Ÿ');
            }

            if (!testResults.permissions) {
                suggestions.push('ğŸ”´ AIæƒé™ä¸è¶³ - è¯·è”ç³»ç®¡ç†å‘˜åˆ†é…AIç›¸å…³æƒé™');
            }

            if (testResults.database && !testResults.database.accessible) {
                suggestions.push('ğŸ”´ æ•°æ®åº“è®¿é—®å¤±è´¥ - è¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œæƒé™');
            }

            if (testResults.database && testResults.database.configCount === 0) {
                suggestions.push('ğŸŸ¡ æ•°æ®åº“ä¸­æ— AIé…ç½® - è¿™æ˜¯AIåŠŸèƒ½æ— æ³•ä½¿ç”¨çš„ä¸»è¦åŸå› ');
            }

            if (testResults.configSave && !testResults.configSave.success) {
                suggestions.push('ğŸ”´ é…ç½®ä¿å­˜å¤±è´¥ - è¯·æ£€æŸ¥æ•°æ®æ ¼å¼å’Œåç«¯éªŒè¯é€»è¾‘');
            }

            if (testResults.configFetch && !testResults.configFetch.success) {
                suggestions.push('ğŸ”´ é…ç½®è·å–å¤±è´¥ - è¯·æ£€æŸ¥APIæ¥å£å’Œæƒé™');
            }

            if (testResults.chat && !testResults.chat.success) {
                suggestions.push('ğŸ”´ èŠå¤©åŠŸèƒ½å¤±è´¥ - è¯·æ£€æŸ¥AIé…ç½®å’ŒAPIå¯†é’¥');
            }

            // ç”ŸæˆæŠ¥å‘Š
            report += `æµ‹è¯•ç»“æœæ±‡æ€»:\n`;
            report += `- åç«¯è¿æ¥: ${testResults.connection ? 'âœ…' : 'âŒ'}\n`;
            report += `- ç”¨æˆ·è®¤è¯: ${testResults.auth ? 'âœ…' : 'âŒ'}\n`;
            report += `- AIæƒé™: ${testResults.permissions ? 'âœ…' : 'âŒ'}\n`;
            report += `- æ•°æ®åº“: ${testResults.database?.accessible ? 'âœ…' : 'âŒ'}\n`;
            report += `- é…ç½®ä¿å­˜: ${testResults.configSave?.success ? 'âœ…' : 'âŒ'}\n`;
            report += `- é…ç½®è·å–: ${testResults.configFetch?.success ? 'âœ…' : 'âŒ'}\n`;
            report += `- èŠå¤©åŠŸèƒ½: ${testResults.chat?.success ? 'âœ…' : 'âŒ'}\n\n`;

            if (suggestions.length > 0) {
                report += `ğŸ› ï¸ ä¿®å¤å»ºè®®:\n${suggestions.join('\n')}\n\n`;
            } else {
                report += 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼AIåŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚\n\n';
            }

            // æ·»åŠ å…·ä½“çš„ä¿®å¤æ­¥éª¤
            if (testResults.database?.configCount === 0) {
                report += `ğŸ“ ç«‹å³ä¿®å¤æ­¥éª¤:\n`;
                report += `1. ç‚¹å‡»ä¸Šæ–¹"æµ‹è¯•ä¿å­˜é…ç½®"æŒ‰é’®åˆ›å»ºä¸€ä¸ªæµ‹è¯•é…ç½®\n`;
                report += `2. å¡«å†™æœ‰æ•ˆçš„APIå¯†é’¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\n`;
                report += `3. ä¿å­˜æˆåŠŸåï¼ŒAIåŠŸèƒ½åº”è¯¥å¯ä»¥ä½¿ç”¨\n`;
                report += `4. åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¯·ä½¿ç”¨çœŸå®çš„APIå¯†é’¥\n\n`;
            }

            fixDiv.textContent = report;
            fixDiv.className = suggestions.length > 0 ? 'result warning' : 'result success';
        }

        // è‡ªåŠ¨ä¿®å¤
        async function runAutoFix() {
            if (!checkLoginRequired()) return;
            
            const resultDiv = document.getElementById('result8');
            const btn = document.getElementById('btn8b');
            
            btn.disabled = true;
            resultDiv.textContent = 'å¼€å§‹è‡ªåŠ¨ä¿®å¤...\n';
            resultDiv.className = 'result info';

            try {
                // 1. å…ˆè¿è¡Œè¯Šæ–­
                await runCompleteTest();
                
                // 2. å¦‚æœæ²¡æœ‰é…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
                if (testResults.database?.configCount === 0) {
                    resultDiv.textContent += '\næ­£åœ¨è‡ªåŠ¨åˆ›å»ºæµ‹è¯•é…ç½®...\n';
                    
                    // å¡«å†™é»˜è®¤å€¼
                    document.getElementById('testConfigName').value = 'è‡ªåŠ¨ä¿®å¤é…ç½®';
                    document.getElementById('testProvider').value = 'openai';
                    document.getElementById('testModel').value = 'gpt-3.5-turbo';
                    document.getElementById('testApiKey').value = 'sk-auto-fix-test-key-please-replace-with-real-key';
                    
                    await testConfigSave();
                    
                    if (testResults.configSave?.success) {
                        resultDiv.textContent += 'âœ… è‡ªåŠ¨åˆ›å»ºé…ç½®æˆåŠŸï¼\n';
                        
                        // é‡æ–°è·å–é…ç½®
                        await testConfigFetch();
                        
                        resultDiv.textContent += 'ğŸ‰ è‡ªåŠ¨ä¿®å¤å®Œæˆï¼\n';
                        resultDiv.textContent += 'âš ï¸ è¯·æ³¨æ„ï¼šè‡ªåŠ¨åˆ›å»ºçš„é…ç½®ä½¿ç”¨çš„æ˜¯æµ‹è¯•APIå¯†é’¥ï¼Œè¯·åœ¨å®é™…ä½¿ç”¨å‰æ›¿æ¢ä¸ºçœŸå®çš„APIå¯†é’¥ã€‚\n';
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.textContent += 'âŒ è‡ªåŠ¨åˆ›å»ºé…ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥é—®é¢˜ã€‚\n';
                        resultDiv.className = 'result error';
                    }
                } else {
                    resultDiv.textContent += 'âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€è‡ªåŠ¨ä¿®å¤ã€‚\n';
                    resultDiv.className = 'result success';
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ è‡ªåŠ¨ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}\n`;
                resultDiv.className = 'result error';
            } finally {
                btn.disabled = false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('AIåŠŸèƒ½å®Œæ•´è¯Šæ–­å·¥å…·å·²åŠ è½½');
            console.log('APIåœ°å€:', API_BASE_URL);
            console.log('è®¤è¯Token:', getAuthToken() ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
            
            // æ›´æ–°ç™»å½•çŠ¶æ€
            updateLoginStatus();
            
            // å°è¯•ä»URLå‚æ•°è·å–token
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            if (urlToken) {
                setAuthToken(urlToken);
                // æ¸…é™¤URLä¸­çš„tokenå‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };
    </script>
</body>
</html>
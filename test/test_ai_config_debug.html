<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI配置调试测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: #409eff;
            color: white;
        }
        .btn-success {
            background: #67c23a;
            color: white;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .error {
            background: #fef0f0;
            border-color: #fbc4c4;
            color: #c53030;
        }
        .success {
            background: #f0f9ff;
            border-color: #b3d8ff;
            color: #0066cc;
        }
        .provider-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .provider-btn {
            padding: 10px 15px;
            border: 2px solid #e4e7ed;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .provider-btn:hover {
            border-color: #409eff;
            background: #f0f9ff;
        }
        .provider-btn.active {
            border-color: #409eff;
            background: #e6f7ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI配置调试测试</h1>
        
        <div class="test-section">
            <h3>选择提供商</h3>
            <div class="provider-buttons">
                <div class="provider-btn" data-provider="openai">OpenAI</div>
                <div class="provider-btn" data-provider="azure">Azure OpenAI</div>
                <div class="provider-btn" data-provider="custom">自定义模型</div>
            </div>
        </div>

        <div class="test-section">
            <h3>配置表单</h3>
            <form id="configForm">
                <div class="form-group">
                    <label for="name">配置名称 *</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="provider">服务提供商 *</label>
                    <select id="provider" name="provider" required>
                        <option value="">请选择提供商</option>
                        <option value="openai">OpenAI</option>
                        <option value="azure">Azure OpenAI</option>
                        <option value="custom">自定义模型</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="api_key">API密钥 *</label>
                    <input type="password" id="api_key" name="api_key" required>
                </div>
                
                <div class="form-group" id="endpointGroup" style="display: none;">
                    <label for="api_endpoint">API端点 *</label>
                    <input type="url" id="api_endpoint" name="api_endpoint">
                    <small id="endpointTip" style="color: #666; font-size: 12px; margin-top: 5px; display: block;"></small>
                </div>
                
                <div class="form-group">
                    <label for="model">模型 *</label>
                    <select id="model" name="model" required>
                        <option value="">请选择模型</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="max_tokens">最大Token数</label>
                    <input type="number" id="max_tokens" name="max_tokens" value="4096" min="1" max="32000">
                </div>
                
                <div class="form-group">
                    <label for="temperature">温度参数</label>
                    <input type="number" id="temperature" name="temperature" value="0.7" min="0" max="2" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_default" name="is_default"> 设为默认配置
                    </label>
                </div>
            </form>
            
            <button type="button" class="btn btn-primary" onclick="validateAndSave()">验证并保存</button>
            <button type="button" class="btn btn-success" onclick="testConnection()">测试连接</button>
            
            <div id="result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const modelOptions = {
            openai: [
                { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                { value: 'gpt-4', label: 'GPT-4' },
                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                { value: 'gpt-4o', label: 'GPT-4o' }
            ],
            azure: [
                { value: 'gpt-35-turbo', label: 'GPT-3.5 Turbo' },
                { value: 'gpt-4', label: 'GPT-4' },
                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' }
            ],
            custom: [
                { value: 'custom-model', label: '自定义模型' },
                { value: 'llama-2', label: 'Llama 2' },
                { value: 'mistral', label: 'Mistral' }
            ]
        };

        const endpointTips = {
            azure: 'Azure OpenAI的API端点，如：https://your-resource.openai.azure.com',
            custom: '自定义模型的API端点，如：http://localhost:8000/v1'
        };

        const defaultEndpoints = {
            azure: 'https://your-resource.openai.azure.com',
            custom: 'http://localhost:8000/v1'
        };

        // 初始化事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 提供商按钮点击事件
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const provider = this.dataset.provider;
                    selectProvider(provider);
                });
            });

            // 提供商选择变化事件
            document.getElementById('provider').addEventListener('change', function() {
                updateFormForProvider(this.value);
            });
        });

        // 选择提供商
        function selectProvider(provider) {
            // 更新按钮状态
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-provider="${provider}"]`).classList.add('active');

            // 更新表单
            document.getElementById('provider').value = provider;
            document.getElementById('name').value = `${getProviderName(provider)} 配置`;
            updateFormForProvider(provider);
            
            showResult(`选择了提供商: ${provider}`, 'success');
        }

        // 根据提供商更新表单
        function updateFormForProvider(provider) {
            const endpointGroup = document.getElementById('endpointGroup');
            const endpointInput = document.getElementById('api_endpoint');
            const endpointTip = document.getElementById('endpointTip');
            const modelSelect = document.getElementById('model');

            // 显示/隐藏端点字段
            if (provider === 'azure' || provider === 'custom') {
                endpointGroup.style.display = 'block';
                endpointInput.required = true;
                endpointInput.value = defaultEndpoints[provider] || '';
                endpointTip.textContent = endpointTips[provider] || '';
            } else {
                endpointGroup.style.display = 'none';
                endpointInput.required = false;
                endpointInput.value = '';
            }

            // 更新模型选项
            modelSelect.innerHTML = '<option value="">请选择模型</option>';
            if (modelOptions[provider]) {
                modelOptions[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.label;
                    modelSelect.appendChild(option);
                });
                
                // 设置默认模型
                if (modelOptions[provider].length > 0) {
                    modelSelect.value = modelOptions[provider][0].value;
                }
            }
            
            showResult(`更新表单为提供商: ${provider}`, 'success');
        }

        // 获取提供商名称
        function getProviderName(provider) {
            const names = {
                openai: 'OpenAI',
                azure: 'Azure OpenAI',
                custom: '自定义模型'
            };
            return names[provider] || provider;
        }

        // 验证并保存
        function validateAndSave() {
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            
            // 获取表单数据
            const data = {
                name: formData.get('name')?.trim(),
                provider: formData.get('provider'),
                api_key: formData.get('api_key')?.trim(),
                api_endpoint: formData.get('api_endpoint')?.trim() || '',
                model: formData.get('model')?.trim(),
                max_tokens: parseInt(formData.get('max_tokens')) || 4096,
                temperature: parseFloat(formData.get('temperature')) || 0.7,
                is_default: formData.get('is_default') === 'on'
            };

            // 验证必填字段
            const errors = [];
            
            if (!data.name) {
                errors.push('请输入配置名称');
            }
            
            if (!data.provider) {
                errors.push('请选择服务提供商');
            }
            
            if (!data.api_key) {
                errors.push('请输入API密钥');
            }
            
            if (!data.model) {
                errors.push('请选择模型');
            }
            
            // 检查API端点
            const needsEndpoint = data.provider === 'azure' || data.provider === 'custom';
            if (needsEndpoint && !data.api_endpoint) {
                errors.push('请输入API端点');
            }

            if (errors.length > 0) {
                showResult(`验证失败:\n${errors.join('\n')}`, 'error');
                return;
            }

            // 构建最终配置数据
            const configData = {
                name: data.name,
                provider: data.provider,
                api_key: data.api_key,
                api_endpoint: data.api_endpoint,
                model: data.model,
                config: '',
                categories: ['chat'],
                tags: ['production'],
                description: `${getProviderName(data.provider)} 配置`,
                priority: 5,
                is_active: true,
                is_default: data.is_default,
                max_tokens: data.max_tokens,
                temperature: data.temperature,
                daily_limit: 0,
                monthly_limit: 0,
                cost_per_token: 0
            };

            showResult(`✅ 验证通过！\n\n发送的配置数据:\n${JSON.stringify(configData, null, 2)}`, 'success');
            
            // 这里可以发送到后端
            // sendToBackend(configData);
        }

        // 测试连接
        function testConnection() {
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            
            const testData = {
                provider: formData.get('provider'),
                api_key: formData.get('api_key')?.trim(),
                api_endpoint: formData.get('api_endpoint')?.trim() || '',
                model: formData.get('model')?.trim()
            };

            if (!testData.provider || !testData.api_key || !testData.model) {
                showResult('请先填写提供商、API密钥和模型', 'error');
                return;
            }

            showResult(`测试连接数据:\n${JSON.stringify(testData, null, 2)}`, 'success');
        }

        // 显示结果
        function showResult(message, type) {
            const resultElement = document.getElementById('result');
            resultElement.textContent = message;
            resultElement.className = `result ${type}`;
            resultElement.style.display = 'block';
        }

        // 发送到后端（示例）
        async function sendToBackend(configData) {
            try {
                const response = await fetch('/api/ai/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`✅ 配置保存成功\n响应: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const error = await response.json();
                    showResult(`❌ 配置保存失败\n状态码: ${response.status}\n错误详情: ${JSON.stringify(error, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 网络错误: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
import{_ as we}from"./_plugin-vue_export-helper-BJA4NJ9J.js";/* empty css                   *//* empty css                *//* empty css                     *//* empty css                  *//* empty css                    *//* empty css                             *//* empty css                 *//* empty css                     *//* empty css                  *//* empty css               *//* empty css                  */import{y as Re,r as b,l as Ee,c as V,aC as ke,h as xe,j as Ue,z as p,R as l,J as n,aB as Oe,L as R,I as _,B as u,Q as S,a6 as A,al as C,O as m,P as v,A as r}from"./vendor-B2dHd6i_.js";import{u as Se,A as w,h as F}from"./index-Co-C_Vux.js";import{z as Ae,I as Fe,E as c,b as Te,y as Be,A as Ie,c as $e,J as Me,K as De,d as Le,R as Ne,l as Pe,f as ze,F as qe,u as je,S as Je,L as He}from"./element-CUclIBtA.js";import"./utils-xdQVjYpF.js";const Ke={class:"record-form"},Qe={class:"card-header"},We={class:"header-actions"},Ye={key:0,class:"dynamic-fields"},Ge={key:5,class:"file-upload"},Xe={class:"flex-between"},Ze={key:0,class:"ocr-result"},et={class:"ocr-actions"},tt={class:"form-actions"},at={class:"preview-content"},lt={class:"preview-meta"},ot={key:0,class:"preview-fields"},nt={class:"field-value"},st=Re({__name:"RecordFormView",setup(rt){const T=ke(),B=Oe(),H=Se(),I=b(),E=b(!1),k=b(!1),$=b(!1),x=b([]),y=b(null),o=Ee({type:"",title:"",status:"draft",content:{}}),f=V(()=>!!T.params.id),D=V(()=>Number(T.params.id)),g=V(()=>x.value.find(t=>t.name===o.type)),K=V(()=>w.FILES.UPLOAD),Q=V(()=>w.FILES.OCR),L=V(()=>({Authorization:`Bearer ${H.token}`})),W={type:[{required:!0,message:"请选择记录类型",trigger:"change"}],title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:200,message:"标题长度在 1 到 200 个字符",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},Y=t=>{const e=[];return t.required&&e.push({required:!0,message:`请输入${t.label}`,trigger:t.type==="select"?"change":"blur"}),t.validation&&(t.validation.min!==void 0&&e.push({min:t.validation.min,message:`${t.label}最少${t.validation.min}个字符`,trigger:"blur"}),t.validation.max!==void 0&&e.push({max:t.validation.max,message:`${t.label}最多${t.validation.max}个字符`,trigger:"blur"})),e},G=t=>({draft:"info",published:"success",archived:"warning"})[t]||"info",X=t=>({draft:"草稿",published:"已发布",archived:"已归档"})[t]||t,Z=(t,e)=>e==null||e===""?"未填写":t.type==="file"&&Array.isArray(e)?e.map(s=>s.originalName).join(", "):String(e),ee=t=>{const e=o.content[t];return Array.isArray(e)?e.map(s=>({name:s.originalName,url:s.path,uid:s.id})):[]},te=async()=>{try{const t=await F.get(w.RECORD_TYPES.LIST);x.value=t}catch(t){console.error("Failed to load record types:",t),c.error("加载记录类型失败")}},N=async()=>{if(f.value)try{const t=await F.get(w.RECORDS.DETAIL(D.value));o.type=t.type,o.title=t.title,o.status=t.status,o.content=t.content||{}}catch(t){console.error("Failed to load record:",t),c.error("加载记录失败"),B.push("/records")}},ae=t=>{const e=x.value.find(d=>d.name===t);if(!e)return;const s={};e.fields.forEach(d=>{if(o.content[d.name]!==void 0)s[d.name]=o.content[d.name];else switch(d.type){case"number":s[d.name]=0;break;case"file":s[d.name]=[];break;default:s[d.name]=""}}),o.content=s},le=t=>t.size/1024/1024<10?!0:(c.error("文件大小不能超过 10MB"),!1),oe=(t,e)=>{Array.isArray(o.content[e])||(o.content[e]=[]),o.content[e].push(t.file),c.success("文件上传成功")},ne=t=>{console.error("File upload failed:",t),c.error("文件上传失败")},se=t=>{const e=t.type.startsWith("image/"),s=t.size/1024/1024<5;return e?s?!0:(c.error("图片大小不能超过 5MB"),!1):(c.error("只能上传图片文件"),!1)},re=t=>{y.value=t,c.success("OCR识别完成")},ue=t=>{console.error("OCR failed:",t),c.error("OCR识别失败")},de=()=>{if(!y.value||!g.value)return;const t=g.value.fields.find(e=>e.type==="text"||e.type==="textarea");if(t){const e=o.content[t.name]||"";o.content[t.name]=e+(e?`
`:"")+y.value.text,c.success("OCR结果已插入")}else c.warning("没有找到可插入的文本字段")},ie=()=>{$.value=!0},P=async()=>{if(I.value)try{await I.value.validate(),E.value=!0;const t={type:o.type,title:o.title,status:o.status,content:o.content};f.value?(await F.put(w.RECORDS.UPDATE(D.value),t),c.success("记录更新成功")):(await F.post(w.RECORDS.CREATE,t),c.success("记录创建成功")),B.push("/records")}catch(t){console.error("Save failed:",t),c.error(t.message||"保存失败")}finally{E.value=!1}},ce=async()=>{try{await je.confirm("确定要取消吗？未保存的更改将丢失。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),B.push("/records")}catch{}};return xe(async()=>{await te(),f.value&&await N()}),Ue(()=>T.params.id,()=>{f.value?N():Object.assign(o,{type:"",title:"",status:"draft",content:{}})}),(t,e)=>{const s=ze,d=De,M=Me,U=$e,z=Ie,pe=Be,O=Le,me=Je,_e=He,ve=C("Upload"),h=Pe,q=Ne,ye=C("Close"),fe=C("upload-filled"),j=Ae,ge=C("Camera"),he=C("View"),be=C("Check"),Ve=Te,J=qe,Ce=Fe;return r(),p("div",Ke,[l(j,null,{header:n(()=>[u("div",Qe,[u("h3",null,v(f.value?"编辑记录":"创建记录"),1),u("div",We,[l(s,{onClick:ce},{default:n(()=>[...e[8]||(e[8]=[m("取消",-1)])]),_:1}),l(s,{type:"primary",loading:E.value,onClick:P},{default:n(()=>[m(v(f.value?"更新":"创建"),1)]),_:1},8,["loading"])])])]),default:n(()=>[l(Ve,{ref_key:"formRef",ref:I,model:o,rules:W,"label-width":"100px",class:"record-form-content"},{default:n(()=>[l(pe,{gutter:20},{default:n(()=>[l(z,{xs:24,md:12},{default:n(()=>[l(U,{label:"记录类型",prop:"type"},{default:n(()=>[l(M,{modelValue:o.type,"onUpdate:modelValue":e[0]||(e[0]=a=>o.type=a),placeholder:"选择记录类型",onChange:ae,style:{width:"100%"}},{default:n(()=>[(r(!0),p(S,null,A(x.value,a=>(r(),_(d,{key:a.id,label:a.name,value:a.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(z,{xs:24,md:12},{default:n(()=>[l(U,{label:"状态",prop:"status"},{default:n(()=>[l(M,{modelValue:o.status,"onUpdate:modelValue":e[1]||(e[1]=a=>o.status=a),placeholder:"选择状态",style:{width:"100%"}},{default:n(()=>[l(d,{label:"草稿",value:"draft"}),l(d,{label:"已发布",value:"published"}),l(d,{label:"已归档",value:"archived"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(U,{label:"标题",prop:"title"},{default:n(()=>[l(O,{modelValue:o.title,"onUpdate:modelValue":e[2]||(e[2]=a=>o.title=a),placeholder:"请输入记录标题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),g.value?(r(),p("div",Ye,[e[11]||(e[11]=u("h4",null,"记录内容",-1)),(r(!0),p(S,null,A(g.value.fields,a=>(r(),p("div",{key:a.name,class:"dynamic-field"},[l(U,{label:a.label,prop:`content.${a.name}`,rules:Y(a)},{default:n(()=>[a.type==="text"?(r(),_(O,{key:0,modelValue:o.content[a.name],"onUpdate:modelValue":i=>o.content[a.name]=i,placeholder:`请输入${a.label}`},null,8,["modelValue","onUpdate:modelValue","placeholder"])):a.type==="textarea"?(r(),_(O,{key:1,modelValue:o.content[a.name],"onUpdate:modelValue":i=>o.content[a.name]=i,type:"textarea",rows:4,placeholder:`请输入${a.label}`},null,8,["modelValue","onUpdate:modelValue","placeholder"])):a.type==="number"?(r(),_(me,{key:2,modelValue:o.content[a.name],"onUpdate:modelValue":i=>o.content[a.name]=i,placeholder:`请输入${a.label}`,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])):a.type==="date"?(r(),_(_e,{key:3,modelValue:o.content[a.name],"onUpdate:modelValue":i=>o.content[a.name]=i,type:"date",placeholder:`请选择${a.label}`,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])):a.type==="select"?(r(),_(M,{key:4,modelValue:o.content[a.name],"onUpdate:modelValue":i=>o.content[a.name]=i,placeholder:`请选择${a.label}`,style:{width:"100%"}},{default:n(()=>[(r(!0),p(S,null,A(a.options,i=>(r(),_(d,{key:i,label:i,value:i},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):a.type==="file"?(r(),p("div",Ge,[l(q,{action:K.value,headers:L.value,"on-success":i=>oe(i,a.name),"on-error":ne,"before-upload":le,"file-list":ee(a.name),multiple:""},{tip:n(()=>[...e[10]||(e[10]=[u("div",{class:"el-upload__tip"}," 支持常见文件格式，单个文件不超过 10MB ",-1)])]),default:n(()=>[l(s,{type:"primary"},{default:n(()=>[l(h,null,{default:n(()=>[l(ve)]),_:1}),e[9]||(e[9]=m(" 上传文件 ",-1))]),_:1})]),_:1},8,["action","headers","on-success","file-list"])])):R("",!0)]),_:2},1032,["label","prop","rules"])]))),128))])):R("",!0),k.value?(r(),_(j,{key:1,class:"ocr-card",shadow:"never"},{header:n(()=>[u("div",Xe,[e[12]||(e[12]=u("span",null,"OCR文字识别",-1)),l(s,{size:"small",onClick:e[3]||(e[3]=a=>k.value=!1)},{default:n(()=>[l(h,null,{default:n(()=>[l(ye)]),_:1})]),_:1})])]),default:n(()=>[l(q,{action:Q.value,headers:L.value,"on-success":re,"on-error":ue,"before-upload":se,drag:"",accept:"image/*"},{tip:n(()=>[...e[13]||(e[13]=[u("div",{class:"el-upload__tip"}," 支持 jpg/png/gif 格式，文件大小不超过 5MB ",-1)])]),default:n(()=>[l(h,{class:"el-icon--upload"},{default:n(()=>[l(fe)]),_:1}),e[14]||(e[14]=u("div",{class:"el-upload__text"},[m(" 将图片拖到此处，或"),u("em",null,"点击上传")],-1))]),_:1},8,["action","headers"]),y.value?(r(),p("div",Ze,[e[17]||(e[17]=u("h5",null,"识别结果：",-1)),l(O,{modelValue:y.value.text,"onUpdate:modelValue":e[4]||(e[4]=a=>y.value.text=a),type:"textarea",rows:6,placeholder:"OCR识别结果将显示在这里"},null,8,["modelValue"]),u("div",et,[l(s,{onClick:de},{default:n(()=>[...e[15]||(e[15]=[m("插入到内容",-1)])]),_:1}),l(s,{onClick:e[5]||(e[5]=a=>y.value=null)},{default:n(()=>[...e[16]||(e[16]=[m("清除",-1)])]),_:1})])])):R("",!0)]),_:1})):R("",!0),u("div",tt,[l(s,{onClick:e[6]||(e[6]=a=>k.value=!k.value)},{default:n(()=>[l(h,null,{default:n(()=>[l(ge)]),_:1}),e[18]||(e[18]=m(" OCR识别 ",-1))]),_:1}),l(s,{onClick:ie},{default:n(()=>[l(h,null,{default:n(()=>[l(he)]),_:1}),e[19]||(e[19]=m(" 预览 ",-1))]),_:1}),l(s,{type:"primary",loading:E.value,onClick:P},{default:n(()=>[l(h,null,{default:n(()=>[l(be)]),_:1}),m(" "+v(f.value?"更新":"保存"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1}),l(Ce,{modelValue:$.value,"onUpdate:modelValue":e[7]||(e[7]=a=>$.value=a),title:"记录预览",width:"80%",top:"5vh"},{default:n(()=>[u("div",at,[u("h2",null,v(o.title),1),u("div",lt,[l(J,null,{default:n(()=>[m(v(o.type),1)]),_:1}),l(J,{type:G(o.status)},{default:n(()=>[m(v(X(o.status)),1)]),_:1},8,["type"])]),g.value?(r(),p("div",ot,[(r(!0),p(S,null,A(g.value.fields,a=>(r(),p("div",{key:a.name,class:"preview-field"},[u("label",null,v(a.label)+"：",1),u("div",nt,v(Z(a,o.content[a.name])),1)]))),128))])):R("",!0)])]),_:1},8,["modelValue"])])}}}),Rt=we(st,[["__scopeId","data-v-546af75a"]]);export{Rt as default};
//# sourceMappingURL=RecordFormView-BUV9L87e.js.map
